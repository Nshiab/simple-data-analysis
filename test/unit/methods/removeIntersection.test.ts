import { existsSync, mkdirSync, readFileSync } from "fs"
import assert from "assert"
import SimpleNodeDB from "../../../src/class/SimpleNodeDB.js"

describe("removeIntersection", () => {
    const output = "./test/output/"

    let simpleNodeDB: SimpleNodeDB
    before(async function () {
        if (!existsSync(output)) {
            mkdirSync(output)
        }
        simpleNodeDB = new SimpleNodeDB({ spatial: true })
    })
    after(async function () {
        await simpleNodeDB.done()
    })

    it("should remove the small circle from the big circle", async () => {
        await simpleNodeDB.loadGeoData(
            "smallCircle",
            "test/geodata/files/smallCircle.json"
        )
        await simpleNodeDB.renameColumns("smallCircle", {
            geom: "smallCircleGeom",
        })

        await simpleNodeDB.loadGeoData(
            "bigCircle",
            "test/geodata/files/bigCircle.json"
        )
        await simpleNodeDB.renameColumns("bigCircle", { geom: "bigCircleGeom" })

        await simpleNodeDB.crossJoin("smallCircle", "bigCircle", {
            outputTable: "joined",
        })
        await simpleNodeDB.removeIntersection(
            "joined",
            ["bigCircleGeom", "smallCircleGeom"],
            "bigCircleWithHole"
        )

        await simpleNodeDB.selectColumns("joined", "bigCircleWithHole")
        await simpleNodeDB.writeGeoData(
            "joined",
            "test/output/bigCircleWithHole.geojson"
        )

        const data = JSON.parse(
            readFileSync("test/output/bigCircleWithHole.geojson", "utf-8")
        )

        assert.deepStrictEqual(data, {
            type: "FeatureCollection",
            name: "bigCircleWithHole",
            features: [
                {
                    type: "Feature",
                    properties: {},
                    geometry: {
                        type: "Polygon",
                        coordinates: [
                            [
                                [-96.991547545101412, 63.776519623142093],
                                [-94.445836615457452, 63.541740399843654],
                                [-92.020872407910218, 63.157147163028171],
                                [-89.766058844399311, 62.632196921050777],
                                [-87.719790890641391, 61.97905276196434],
                                [-85.908660813003294, 61.211755601371244],
                                [-84.348048973255146, 60.345422598289083],
                                [-83.043650019698575, 59.39555726974163],
                                [-81.993449443310737, 58.377513199419639],
                                [-81.189755679875006, 57.30611668506949],
                                [-80.621032211524252, 56.195430036668832],
                                [-80.273405096953354, 55.05862633286381],
                                [-80.131817115967706, 53.907944791488447],
                                [-80.18085661755147, 52.754699491350195],
                                [-80.405315212237184, 51.609319847270172],
                                [-80.790534479370564, 50.481407046594029],
                                [-81.32259708015691, 49.379795659819557],
                                [-81.988408380796997, 48.312613542664373],
                                [-82.775704566407455, 47.287335995261415],
                                [-83.67301406765614, 46.310832119459036],
                                [-84.669591593847571, 45.38940262875682],
                                [-85.755338231042955, 44.528809205470793],
                                [-86.920716714075169, 43.734296014585119],
                                [-88.156667824346357, 43.01060428163732],
                                [-89.454531614173987, 42.361980997551129],
                                [-90.805975569172375, 41.792182875644727],
                                [-92.202930700959513, 41.304476685911766],
                                [-93.637535770553058, 40.901637047570638],
                                [-95.10208927628166, 40.585942683457787],
                                [-96.589008429087372, 40.359172035211991],
                                [-98.090794036924876, 40.222599010229672],
                                [-99.600000000000307, 40.176989483221028],
                                [-101.109205963075738, 40.222599010229672],
                                [-102.610991570913242, 40.359172035211991],
                                [-104.09791072371894, 40.585942683457787],
                                [-105.562464229447571, 40.901637047570645],
                                [-106.997069299041101, 41.304476685911766],
                                [-108.394024430828225, 41.792182875644727],
                                [-109.745468385826626, 42.361980997551129],
                                [-111.043332175654243, 43.01060428163732],
                                [-112.27928328592543, 43.734296014585119],
                                [-113.444661768957658, 44.5288092054708],
                                [-114.530408406153043, 45.38940262875682],
                                [-115.526985932344502, 46.310832119459036],
                                [-116.424295433593159, 47.287335995261415],
                                [-117.211591619203617, 48.312613542664373],
                                [-117.877402919843689, 49.379795659819557],
                                [-118.40946552063005, 50.481407046594029],
                                [-118.794684787763444, 51.609319847270186],
                                [-119.019143382449158, 52.754699491350195],
                                [-119.068182884032908, 53.907944791488447],
                                [-118.926594903047246, 55.05862633286381],
                                [-118.578967788476362, 56.195430036668832],
                                [-118.01024432012558, 57.30611668506949],
                                [-117.206550556689905, 58.377513199419639],
                                [-116.156349980302011, 59.39555726974163],
                                [-114.851951026745454, 60.345422598289083],
                                [-113.291339186997305, 61.211755601371244],
                                [-111.480209109359222, 61.97905276196434],
                                [-109.433941155601318, 62.632196921050777],
                                [-107.179127592090367, 63.157147163028171],
                                [-104.754163384543148, 63.541740399843654],
                                [-102.208452454899188, 63.776519623142093],
                                [-99.600000000000307, 63.855468199379551],
                                [-96.991547545101412, 63.776519623142093],
                            ],
                            [
                                [-97.626826651818419, 56.655932181702994],
                                [-98.225549870893047, 56.602715037409133],
                                [-98.809485870341277, 56.514753897581066],
                                [-99.371625313094569, 56.393133163442606],
                                [-99.905400150012895, 56.23933836340823],
                                [-100.404799515481258, 56.055225455918197],
                                [-100.864462339003055, 55.842983921788495],
                                [-101.279744621251169, 55.605095239084562],
                                [-101.646761094653968, 55.344288382771616],
                                [-101.962402556819939, 55.063493925925918],
                                [-102.22433140277748, 54.765798161554962],
                                [-102.430958724618989, 54.454398442649229],
                                [-102.581406789541475, 54.13256068279621],
                                [-102.675460791165605, 53.803579697611006],
                                [-102.713513565983064, 53.470742820073582],
                                [-102.696506561253699, 53.1372970057446],
                                [-102.625869815801153, 52.806419465352015],
                                [-102.503463143152288, 52.481191725341169],
                                [-102.331520143518574, 52.164576920266995],
                                [-102.112596156096345, 51.859400060085349],
                                [-101.849520818994122, 51.568330984572626],
                                [-101.545355540620719, 51.293869709815723],
                                [-101.203355903724514, 51.038333881702336],
                                [-100.826938815152417, 50.803848073001248],
                                [-100.419654070798131, 50.592334689251715],
                                [-99.985159914554899, 50.405506280558718],
                                [-99.527202120697623, 50.244859088738707],
                                [-99.049596110130736, 50.111667690146888],
                                [-98.556211612817975, 50.006980622735163],
                                [-98.050959403437673, 49.931616910816111],
                                [-97.537779658392523, 49.886163422495223],
                                [-97.020631504676516, 49.87097301298391],
                                [-96.503483350960508, 49.886163422495223],
                                [-95.990303605915344, 49.931616910816111],
                                [-95.485051396535042, 50.006980622735163],
                                [-94.991666899222295, 50.111667690146888],
                                [-94.514060888655408, 50.244859088738707],
                                [-94.056103094798132, 50.405506280558718],
                                [-93.621608938554886, 50.592334689251715],
                                [-93.214324194200586, 50.803848073001248],
                                [-92.837907105628503, 51.038333881702336],
                                [-92.495907468732298, 51.293869709815723],
                                [-92.191742190358895, 51.568330984572626],
                                [-91.928666853256672, 51.859400060085349],
                                [-91.709742865834443, 52.164576920266995],
                                [-91.537799866200729, 52.481191725341169],
                                [-91.415393193551864, 52.806419465352015],
                                [-91.344756448099332, 53.1372970057446],
                                [-91.327749443369953, 53.470742820073582],
                                [-91.365802218187397, 53.803579697611006],
                                [-91.459856219811542, 54.13256068279621],
                                [-91.610304284734042, 54.454398442649229],
                                [-91.816931606575523, 54.765798161554962],
                                [-92.078860452533078, 55.063493925925918],
                                [-92.394501914699049, 55.344288382771616],
                                [-92.761518388101848, 55.605095239084562],
                                [-93.176800670349976, 55.842983921788495],
                                [-93.636463493871759, 56.055225455918197],
                                [-94.135862859340136, 56.23933836340823],
                                [-94.669637696258448, 56.393133163442606],
                                [-95.23177713901174, 56.514753897581066],
                                [-95.815713138459955, 56.602715037409133],
                                [-96.414436357534598, 56.655932181702994],
                                [-97.020631504676516, 56.673745125499089],
                                [-97.626826651818419, 56.655932181702994],
                            ],
                        ],
                    },
                },
            ],
        })
    })
})
